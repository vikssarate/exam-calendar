<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Upcoming Exam Calendar</title>
<style>
:root{--bg:#0f1220;--card:#161b2b;--ink:#eef1ff;--muted:#9aa3c7;--line:#2a3052;--accent:#6ca8ff;--ok:#7bd88f;--warn:#ffd166;--bad:#ff7575}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
header,footer{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;gap:10px;flex-wrap:wrap}
h1{margin:0;font-size:18px;font-weight:700}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 0 0 1px var(--line)}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button,textarea{padding:9px 10px;border-radius:10px;border:1px solid var(--line);background:#101429;color:var(--ink)}
button.primary{background:var(--accent);color:#071225;border-color:transparent;font-weight:700}
button.ghost{background:transparent}
button.danger{background:#2a1120;color:#ffd5d5;border-color:#4c1a2d}
.note{color:var(--muted);font-size:12px}
hr{border:none;border-top:1px solid var(--line);margin:10px 0}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tabs button{border-radius:999px;padding:6px 10px}
.tabs button.active{background:var(--accent);color:#071225;border-color:transparent}

/* Calendar */
.cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal .dow{color:var(--muted);text-align:center;font-size:12px;padding-bottom:6px}
.cal .cell{border:1px solid var(--line);border-radius:10px;min-height:90px;padding:6px;display:flex;flex-direction:column}
.cal .other{opacity:.45}
.cal .head{display:flex;justify-content:space-between;align-items:center;font-size:12px}
.cal .num{font-weight:700}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);color:var(--muted)}
.badge.ok{color:#0b3318;background:#112a19;border-color:#224d2d}
.badge.warn{color:#392a00;background:#2b220f;border-color:#4c3f10}
.badge.bad{color:#3a000c;background:#2a0e12;border-color:#4c1a25}
.pill{display:inline-block;font-size:12px;line-height:1.2;padding:4px 6px;margin-top:6px;border:1px solid var(--line);border-radius:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pill small{color:var(--muted)}
.cell .list{margin-top:4px}

/* Upcoming list */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
.table th{color:var(--muted);text-align:left;user-select:none}
.actions button{margin-right:6px}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
.modal.show{display:flex}
.modal>.box{background:var(--card);border-radius:12px;box-shadow:0 0 0 1px var(--line);padding:14px;max-width:720px;width:96%}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:700px){ .grid.cols-2{grid-template-columns:1fr} .hide-sm{display:none} }
</style>
</head>
<body>
<header>
  <h1>Upcoming Exam Calendar</h1>
  <div class="toolbar">
    <select id="who">
      <option value="">All aspirants</option>
    </select>
    <input id="q" placeholder="Search title/org/notes…" />
    <label class="toolbar"><input type="checkbox" id="upcomingOnly" checked/> Upcoming only</label>
    <select id="window">
      <option value="30">Next 30 days</option>
      <option value="60" selected>Next 60 days</option>
      <option value="90">Next 90 days</option>
      <option value="365">Next 12 months</option>
      <option value="0">All dates</option>
    </select>
  </div>
  <div class="toolbar">
    <button id="addBtn" class="primary">+ Add exam</button>
    <button id="reload">Reload data</button>
    <button id="exportCsv">Export CSV</button>
    <button id="exportIcs">Export ICS</button>
    <button id="settingsBtn">Settings</button>
    <!-- NEW: Sync & Pull -->
    <button id="syncNow">Sync</button>
    <button id="pullNow" class="ghost">Pull</button>
    <span class="note" id="countNote"></span>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <div class="tabs">
      <button data-tab="calendar" class="active">Calendar</button>
      <button data-tab="list">Upcoming list</button>
    </div>

    <!-- Calendar view -->
    <div id="calendarView">
      <div class="toolbar" style="justify-content:space-between;margin-bottom:8px">
        <div class="toolbar">
          <button id="prevMonth">◀</button>
          <button id="todayBtn">Today</button>
          <button id="nextMonth">▶</button>
        </div>
        <div class="note" id="monthLabel"></div>
      </div>
      <div class="cal" id="calHeader"></div>
      <div class="cal" id="calGrid"></div>
    </div>

    <!-- List view -->
    <div id="listView" style="display:none">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Exam / Post</th>
            <th class="hide-sm">Organization</th>
            <th>Date</th>
            <th>In</th>
            <th class="hide-sm">Aspirant</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</div>

<footer>
  <span class="note">Loads from <code>/data/jobs.json</code>. Add/edit/delete are saved locally; you can Export or Push to GitHub.</span>
  <span class="note" id="verNote"></span>
</footer>

<!-- Add/Edit Modal -->
<div class="modal" id="editModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px" id="modalTitle">Add exam</h3>
      <button class="ghost" id="closeEdit">✕</button>
    </div>
    <div class="grid cols-2">
      <div><label class="note">Aspirant</label><input id="m_name" /></div>
      <div><label class="note">Organization</label><input id="m_org" placeholder="SSC / IBPS / Railways" /></div>
      <div><label class="note">Exam / Post</label><input id="m_title" placeholder="e.g., SSC JE Civil 2025" /></div>
      <div><label class="note">Status</label>
        <select id="m_status">
          <option>Applied</option><option>Admit Card</option><option>Scheduled</option>
          <option>Written Done</option><option>Result</option><option>Withdrawn</option>
        </select>
      </div>
      <div><label class="note">Exam date</label><input type="date" id="m_examOn" /></div>
      <div><label class="note">Applied on</label><input type="date" id="m_appliedOn" /></div>
      <div class="grid" style="grid-column:1/-1"><label class="note">Notes</label><textarea id="m_notes"></textarea></div>
    </div>
    <div class="toolbar" style="margin-top:10px;justify-content:space-between">
      <div class="toolbar">
        <button id="saveDraft" class="primary">Save</button>
        <button id="pushGithub">Push to GitHub</button>
      </div>
      <span class="note">Set repo/token in Settings, or Export ICS/CSV and jobs JSON.</span>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0;font-size:16px">GitHub settings (optional)</h3>
      <button class="ghost" id="closeSettings">✕</button>
    </div>
    <div class="grid cols-2">
      <div><label class="note">Owner</label><input id="gh_owner" placeholder="your-username" /></div>
      <div><label class="note">Repo</label><input id="gh_repo" placeholder="yourpages.github.io" /></div>
      <div><label class="note">Branch</label><input id="gh_branch" value="main" /></div>
      <div><label class="note">Jobs file path</label><input id="gh_path" value="data/jobs.json" /></div>
      <div style="grid-column:1/-1"><label class="note">Personal Access Token (contents: read & write)</label><input id="gh_token" type="password" placeholder="ghp_..." /></div>
    </div>
    <div class="toolbar" style="margin-top:10px;justify-content:space-between">
      <div class="toolbar">
        <button id="saveCfg" class="primary">Save</button>
        <button id="testPush">Test read</button>
        <button id="clearCfg" class="danger">Clear token</button>
      </div>
      <span class="note">Tip: make a fine-grained token for this single repo.</span>
    </div>
  </div>
</div>

<!-- PouchDB -->
<script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>

<script>
(async function(){
  const JOBS_URL='data/jobs.json';

  // --- DOM -------
  const $=s=>document.querySelector(s);
  const whoSel=$('#who'), q=$('#q'), upcomingOnly=$('#upcomingOnly'), windowSel=$('#window');
  const monthLabel=$('#monthLabel'), calHeader=$('#calHeader'), calGrid=$('#calGrid');
  const rows=$('#rows'), countNote=$('#countNote'), verNote=$('#verNote');
  const addBtn=$('#addBtn'), reloadBtn=$('#reload'), exportCsvBtn=$('#exportCsv'), exportIcsBtn=$('#exportIcs');
  const tabs=document.querySelectorAll('.tabs button'); const calendarView=$('#calendarView'), listView=$('#listView');
  const editModal=$('#editModal'), settingsModal=$('#settingsModal');

  // --- state -----
  const state={
    remote:[], all:[], version:'',
    drafts:load('jcal_drafts',[]), deletes:load('jcal_deletes',[]),
    who: localStorage.getItem('jcal_who') || '',
    sortKey:'examOn', sortDir:'asc', month:new Date(), cfg:load('jcal_cfg',{}),
    currentEditKey:null
  };

  // ===== NEW: COUCH/Pouch config (no auth) =====
  const COUCH_BASE = 'https://couch.techstudy.me';
  const COUCH_DB   = 'calendar';
  const REMOTE_URL = `${COUCH_BASE}/${COUCH_DB}`;
  const LOCAL_DB_NAME = 'jcal-local';
  const STATE_DOC_ID  = 'jcal_state_v1'; // single snapshot doc for this app

  const localDB  = new PouchDB(LOCAL_DB_NAME);
  const remoteDB = new PouchDB(REMOTE_URL, { skip_setup:true });

  let writingToPouch=false, applyingRemote=false, tDeb=null;

  function packState(){
    return {
      drafts: state.drafts,
      deletes: state.deletes,
      cfg: state.cfg,
      who: state.who,
      ver: state.version || '',
      updatedAt: new Date().toISOString()
    };
  }

  async function saveToPouch(){
    try{
      writingToPouch = true;
      let doc;
      try{ doc = await localDB.get(STATE_DOC_ID); }
      catch(e){ if(e.status!==404) throw e; doc={_id:STATE_DOC_ID, app:'gs-record'}; }
      doc.app = 'calendar-record';
      doc.data = packState();
      await localDB.put(doc);
      await PouchDB.replicate(localDB, remoteDB, { doc_ids:[STATE_DOC_ID] });
    }catch(err){ console.error('Pouch save error', err); }
    finally{ writingToPouch=false; }
  }
  function saveToPouchDebounced(){ clearTimeout(tDeb); tDeb=setTimeout(saveToPouch, 300); }

  async function applyDoc(doc){
    if(!doc || !doc.data) return;
    applyingRemote = true;
    const d = doc.data;
    state.drafts = Array.isArray(d.drafts)? d.drafts : [];
    state.deletes = Array.isArray(d.deletes)? d.deletes : [];
    state.cfg = d.cfg || {};
    state.who = d.who || '';
    // persist to localStorage too
    localStorage.setItem('jcal_who', state.who||'');
    saveRaw('jcal_drafts', state.drafts);
    saveRaw('jcal_deletes', state.deletes);
    saveRaw('jcal_cfg', state.cfg);
    compose(); populateWho(); render(); drawCalendar();
    applyingRemote = false;
  }

  async function bootstrapRemoteFirst(){
    try{
      await PouchDB.replicate(remoteDB, localDB, { doc_ids:[STATE_DOC_ID] });
      const doc = await localDB.get(STATE_DOC_ID).catch(()=>null);
      if(doc && doc.data){ await applyDoc(doc); }
      else if((state.drafts.length + state.deletes.length)>0 || Object.keys(state.cfg||{}).length>0){
        // nothing found remotely; seed with our local
        await saveToPouch();
      }
    }catch(e){ console.warn('Bootstrap pull failed', e); }
  }

  function startLiveSync(){
    PouchDB.sync(localDB, remoteDB, { live:true, retry:true })
      .on('error', err => console.error('live sync error', err));

    localDB.changes({ since:'now', live:true, include_docs:true, doc_ids:[STATE_DOC_ID] })
      .on('change', ch => {
        if(writingToPouch || applyingRemote) return;
        if(ch.doc && ch.doc.data) applyDoc(ch.doc);
      })
      .on('error', err => console.error('changes error', err));
  }

  // --- utils -----
  const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmt = s => !s ? '—' : new Date(s+'T00:00:00').toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});

  // NEW: local YYYY-MM-DD (avoid UTC shift)
  function ymdLocal(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  const todayISO = ()=> ymdLocal(new Date());
  function daysUntil(s){ if(!s) return null; const t0=new Date(); const d=new Date(s+'T00:00:00'); const base=new Date(t0.getFullYear(),t0.getMonth(),t0.getDate()); return Math.round((d-base)/86400000); }
  function badge(n){ if(n===null) return '<span class="badge">—</span>'; if(n<0) return `<span class="badge bad">${Math.abs(n)}d past</span>`; if(n===0) return `<span class="badge warn">Today</span>`; if(n<=7) return `<span class="badge warn">${n}d</span>`; if(n<=30) return `<span class="badge ok">${n}d</span>`; return `<span class="badge">${n}d</span>`; }
  const keyOf=r=>[r.name,r.title,r.appliedOn||'',r.examOn||''].map(x=>String(x||'').trim().toLowerCase()).join('|');

  // IMPORTANT: wrap localStorage save to auto-sync
  function saveRaw(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function save(k,v){ saveRaw(k,v); saveToPouchDebounced(); }
  function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch{ return def; } }
  const b64=s=>btoa(unescape(encodeURIComponent(s))); const unb64=s=>decodeURIComponent(escape(atob(s)));

  // --- load/compose ----
  async function loadData(cacheBust=false){
    const url = cacheBust? JOBS_URL+'?v='+Date.now():JOBS_URL;
    let j={jobs:[],version:''};
    try{ const r=await fetch(url,{cache:'no-store'}); if(r.ok){ j=await r.json(); } }catch{}
    state.remote=j.jobs||[]; state.version=j.version||''; verNote.textContent=state.version?('Data version: '+state.version):'';
    compose();
    populateWho();
    render();
    drawCalendar();
  }
  function compose(){
    const map=new Map();
    state.remote.forEach(r=> map.set(keyOf(r), r));
    state.deletes.forEach(k=> map.delete(k));
    state.drafts.forEach(d=> map.set(keyOf(d), {...d,_draft:true}));
    state.all=Array.from(map.values());
  }
  function populateWho(){
    const names = Array.from(new Set(state.all.map(r=>r.name).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    const current = state.who || '';
    whoSel.innerHTML='<option value="">All aspirants</option>'+names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    if(current && names.includes(current)) whoSel.value=current; state.who=whoSel.value;
  }

  // --- filters / views ---
  function applyFilters(arr){
    const term = q.value.trim().toLowerCase();
    const win = parseInt(windowSel.value,10);
    const filtered = arr.filter(r=>{
      if(state.who && r.name!==state.who) return false;
      if(term && ![r.title,r.org,r.notes].some(v=> String(v||'').toLowerCase().includes(term))) return false;
      if(upcomingOnly.checked){
        const n = daysUntil(r.examOn);
        if(n===null || n<0) return false;
        if(win>0 && n>win) return false;
      }
      return true;
    });
    return filtered.sort((a,b)=> (a.examOn||'').localeCompare(b.examOn||''));
  }

  // list render
  function render(){
    const data = applyFilters(state.all).filter(r=>r.examOn);
    rows.innerHTML = data.map(r=>{
      const kenc=encodeURIComponent(keyOf(r));
      return `<tr>
        <td><div style="font-weight:600">${esc(r.title)}</div>${r._draft? ' <span class="badge warn">draft</span>':''}</td>
        <td class="hide-sm">${esc(r.org||'')}</td>
        <td>${fmt(r.examOn)}</td>
        <td>${badge(daysUntil(r.examOn))}</td>
        <td class="hide-sm">${esc(r.name||'')}</td>
        <td class="actions">
          <button onclick="addToGCal('${encodeURIComponent(r.title)}','${r.examOn}','${encodeURIComponent((r.org||'') + (r.notes? ' — '+r.notes:''))}')">+ Google</button>
          <button onclick="downloadICS('${b64(JSON.stringify(r))}')">ICS</button>
          <button class="edit" data-k="${kenc}">Edit</button>
          <button class="danger del" data-k="${kenc}">Delete</button>
        </td>
      </tr>`;
    }).join('');
    countNote.textContent = `${data.length} upcoming ${state.who? 'for '+state.who:''}`;
    localStorage.setItem('jcal_who', state.who||'');
  }

  // calendar render
  function drawCalendar(){
    // DOW header
    const dow=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    calHeader.innerHTML = dow.map(d=>`<div class="dow">${d}</div>`).join('');
    const y=state.month.getFullYear(), m=state.month.getMonth();
    const first=new Date(y,m,1), start=new Date(y,m,1-first.getDay());
    const title=state.month.toLocaleDateString(undefined,{month:'long',year:'numeric'});
    monthLabel.textContent=title;

    // map events per day
    const items = applyFilters(state.all).filter(r=>r.examOn);
    const byDate = new Map();
    items.forEach(r=>{ byDate.set(r.examOn, (byDate.get(r.examOn)||[]).concat([r])); });

    const cells=[];
    for(let i=0;i<42;i++){
      const d=new Date(start); d.setDate(start.getDate()+i);
      const ds = ymdLocal(d); // FIX: use local date, not UTC
      const isOther = d.getMonth()!==m;
      const ev = byDate.get(ds)||[];
      const pills = ev.slice(0,3).map(r=> `<div class="pill" title="${esc(r.title)}">${esc(r.title)} <small>${esc(r.name||'')}</small></div>`).join('');
      const more = ev.length>3? `<div class="pill"><small>+${ev.length-3} more</small></div>` : '';
      cells.push(`<div class="cell ${isOther?'other':''}" data-date="${ds}">
        <div class="head"><span class="num">${d.getDate()}</span></div>
        <div class="list">${pills}${more}</div>
      </div>`);
    }
    calGrid.innerHTML = cells.join('');

    // click a day to open quick add/list
    calGrid.querySelectorAll('.cell').forEach(cell=>{
      cell.addEventListener('click', ()=>{
        const ds=cell.getAttribute('data-date');
        openDay(ds);
      });
    });
  }

  function openDay(ds){
    const list = applyFilters(state.all).filter(r=>r.examOn===ds);
    const nice = new Date(ds+'T00:00:00').toLocaleDateString(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric'});
    $('#modalTitle').textContent = 'Exams on ' + nice;
    setForm({name:state.who||'', org:'', title:'', status:'Applied', appliedOn:todayISO(), examOn:ds, notes:''});
    show(editModal,true);

    const box = editModal.querySelector('.box');
    let listDiv = box.querySelector('#dayList');
    if(!listDiv){ listDiv = document.createElement('div'); listDiv.id='dayList'; listDiv.style.marginBottom='8px'; box.insertBefore(listDiv, box.children[1]); }
    listDiv.innerHTML = list.length? list.map(r=>`<div class="pill">${esc(r.title)} <small>${esc(r.name||'')}</small></div>`).join('') : '<div class="note">No exams on this date yet.</div>';
  }

  // --- tabs & nav ---
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab=btn.getAttribute('data-tab');
      calendarView.style.display = tab==='calendar'? 'block':'none';
      listView.style.display     = tab==='list'? 'block':'none';
    });
  });
  $('#prevMonth').addEventListener('click', ()=>{ state.month.setMonth(state.month.getMonth()-1); drawCalendar(); });
  $('#nextMonth').addEventListener('click', ()=>{ state.month.setMonth(state.month.getMonth()+1); drawCalendar(); });
  $('#todayBtn').addEventListener('click', ()=>{ state.month=new Date(); drawCalendar(); });

  // --- filters change ---
  [whoSel,q,upcomingOnly,windowSel].forEach(el=> el.addEventListener('input', ()=>{
    state.who=whoSel.value; save('jcal_who', state.who); // will also trigger pouch save
    render(); drawCalendar();
  }));

  // --- list actions (edit/delete + calendar links) ---
  rows.addEventListener('click', (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const k = decodeURIComponent(btn.dataset?.k||'');
    if(btn.classList.contains('edit')) return openEdit(k);
    if(btn.classList.contains('del')) return deleteByKey(k);
  });

  // --- add/edit modal ---
  addBtn.addEventListener('click', ()=>{ state.currentEditKey=null; $('#modalTitle').textContent='Add exam'; setForm({name:state.who||'', org:'', title:'', status:'Applied', appliedOn:todayISO(), examOn:'', notes:''}); show(editModal,true); });
  $('#closeEdit').addEventListener('click', ()=> show(editModal,false));
  function setForm(r){ $('#m_name').value=r.name||''; $('#m_org').value=r.org||''; $('#m_title').value=r.title||''; $('#m_status').value=r.status||'Applied'; $('#m_appliedOn').value=r.appliedOn||''; $('#m_examOn').value=r.examOn||''; $('#m_notes').value=r.notes||''; }
  function getForm(){ return { name:$('#m_name').value.trim(), org:$('#m_org').value.trim(), title:$('#m_title').value.trim(), status:$('#m_status').value, appliedOn:$('#m_appliedOn').value, examOn:$('#m_examOn').value, notes:$('#m_notes').value.trim() }; }

  $('#saveDraft').addEventListener('click', ()=>{
    const rec=getForm();
    if(!rec.name||!rec.title){ alert('Please fill Aspirant & Title.'); return; }
    if(!rec.appliedOn) rec.appliedOn = todayISO();
    const newKey=keyOf(rec);
    if(state.currentEditKey && state.currentEditKey!==newKey){
      if(!state.deletes.includes(state.currentEditKey)) state.deletes.push(state.currentEditKey);
      save('jcal_deletes', state.deletes);
      state.drafts = state.drafts.filter(d=> keyOf(d)!==state.currentEditKey);
    }
    const i=state.drafts.findIndex(d=> keyOf(d)===newKey);
    if(i>=0) state.drafts[i]=rec; else state.drafts.push(rec);
    save('jcal_drafts', state.drafts);
    compose(); populateWho(); render(); drawCalendar(); show(editModal,false);
  });

  function openEdit(key){
    const rec = findByKey(key); if(!rec){ alert('Not found'); return; }
    state.currentEditKey=key; $('#modalTitle').textContent='Edit: '+(rec.title||''); setForm(rec); show(editModal,true);
  }
  function deleteByKey(key){
    const rec=findByKey(key); if(!rec) return;
    if(!confirm('Delete this entry?')) return;
    const i=state.drafts.findIndex(d=> keyOf(d)===key);
    if(i>=0){ state.drafts.splice(i,1); save('jcal_drafts',state.drafts); }
    else if(!state.deletes.includes(key)){ state.deletes.push(key); save('jcal_deletes',state.deletes); }
    compose(); render(); drawCalendar();
  }
  function findByKey(k){
    const d=state.drafts.find(x=>keyOf(x)===k); if(d) return {...d,_draft:true};
    const r=state.remote.find(x=>keyOf(x)===k); return r? {...r}:null;
  }

  // --- export buttons ---
  exportCsvBtn.addEventListener('click', ()=>{
    const headers=['name','title','org','appliedOn','examOn','status','notes'];
    const arr = applyFilters(state.all);
    const csv=[headers.join(',')].concat(arr.map(o=> headers.map(h=> '"'+String(o[h]??'').replace(/"/g,'""')+'"' ).join(','))).join('\n');
    download(new Blob([csv],{type:'text/csv'}),'exams.csv');
  });

  exportIcsBtn.addEventListener('click', ()=>{
    const arr = applyFilters(state.all).filter(r=>r.examOn);
    const ics = buildICS(arr);
    download(new Blob([ics],{type:'text/calendar'}),'exams.ics');
  });

  // Google Calendar link for a single item (global fn used in HTML onclick)
  window.addToGCal = (titleEnc, ymd, detailsEnc) => {
    if(!ymd){ alert('No date set'); return; }
    const start = ymd.replaceAll('-',''); // all-day
    const end   = plusDays(ymd,1).replaceAll('-','');
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${titleEnc}&details=${detailsEnc}&dates=${start}/${end}`;
    window.open(url,'_blank');
  };

  // ICS for a single item (global)
  window.downloadICS = (b64json) => {
    const r = JSON.parse(unb64(b64json));
    const ics = buildICS([r]);
    download(new Blob([ics],{type:'text/calendar'}), (r.title||'exam')+'.ics');
  };

  function buildICS(arr){
    const lines=[
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ExamCalendar//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH'
    ];
    const dtstamp = new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
    arr.forEach((r,i)=>{
      if(!r.examOn) return;
      const uid = (keyOf(r)+'@exam').replace(/\s+/g,'');
      const ymd = r.examOn.replaceAll('-','');
      const ymd2 = plusDays(r.examOn,1).replaceAll('-','');
      const summary = (r.title||'Exam') + (r.name? ` — ${r.name}`:'');
      const desc = [r.org, r.status, r.notes].filter(Boolean).join(' | ');
      lines.push('BEGIN:VEVENT');
      lines.push('UID:'+uid);
      lines.push('DTSTAMP:'+dtstamp);
      lines.push('SUMMARY:'+escapeICS(summary));
      lines.push('DESCRIPTION:'+escapeICS(desc));
      lines.push('DTSTART;VALUE=DATE:'+ymd);
      lines.push('DTEND;VALUE=DATE:'+ymd2);
      lines.push('END:VEVENT');
    });
    lines.push('END:VCALENDAR');
    return lines.join('\r\n');
  }
  function escapeICS(s){ return String(s||'').replace(/([,;])/g,'\\$1').replace(/\n/g,'\\n'); }
  function plusDays(ymd, n){
    const d=new Date(ymd+'T00:00:00'); d.setDate(d.getDate()+n);
    return ymdLocal(d); // FIX: use local date, not UTC
  }

  // settings / GitHub
  $('#settingsBtn').addEventListener('click', ()=>{
    show(settingsModal,true);
    $('#gh_owner').value=state.cfg.owner||'';
    $('#gh_repo').value=state.cfg.repo||'';
    $('#gh_branch').value=state.cfg.branch||'main';
    $('#gh_path').value=state.cfg.path||'data/jobs.json';
    $('#gh_token').value=state.cfg.token||'';
  });
  $('#closeSettings').addEventListener('click', ()=> show(settingsModal,false));
  $('#saveCfg').addEventListener('click', ()=>{ state.cfg={ owner:$('#gh_owner').value.trim(), repo:$('#gh_repo').value.trim(), branch:($('#gh_branch').value.trim()||'main'), path:($('#gh_path').value.trim()||'data/jobs.json'), token:$('#gh_token').value.trim() }; save('jcal_cfg',state.cfg); alert('Saved.'); });
  $('#clearCfg').addEventListener('click', ()=>{ state.cfg={}; save('jcal_cfg',state.cfg); alert('Cleared.'); });
  $('#testPush').addEventListener('click', async ()=>{ try{ await ghGetFileMeta(); alert('OK: file accessible'); } catch(e){ alert('Check settings/token: '+e.message);} });
  $('#pushGithub').addEventListener('click', pushToGitHub);

  async function pushToGitHub(){
    if(!(state.cfg && state.cfg.token)){ alert('Add token in Settings first.'); return; }
    try{
      const meta = await ghGetFileMeta().catch(()=>null);
      const existing = meta? JSON.parse(unb64((meta.content||'').replace(/\n/g,''))) : {jobs:[],version:''};
      const merged = mergeForSave(existing);
      const contentB64 = b64(JSON.stringify(merged,null,2));
      const res = await fetch(`https://api.github.com/repos/${state.cfg.owner}/${state.cfg.repo}/contents/${state.cfg.path}`,{
        method:'PUT',
        headers:{ 'Authorization':'Bearer '+state.cfg.token, 'Accept':'application/vnd.github+json' },
        body: JSON.stringify({ message:`Update jobs via calendar app`, content:contentB64, sha:meta && meta.sha, branch:state.cfg.branch })
      });
      if(!res.ok){ const t=await res.text(); throw new Error('GitHub write failed: '+t); }
      state.drafts=[]; state.deletes=[]; save('jcal_drafts',state.drafts); save('jcal_deletes',state.deletes);
      await loadData(true); show(editModal,false); alert('Pushed to GitHub ✔');
    }catch(err){ alert(err.message); }
  }
  function mergeForSave(existing){
    const base=existing||{version:'',jobs:[]};
    const delset=new Set(state.deletes);
    const out={version: new Date().toISOString().slice(0,10), jobs: []};
    base.jobs.forEach(r=>{ if(!delset.has(keyOf(r))) out.jobs.push(r); });
    const map=new Map(out.jobs.map(r=>[keyOf(r),r]));
    state.drafts.forEach(d=> map.set(keyOf(d), d));
    out.jobs = Array.from(map.values());
    return out;
  }
  async function ghGetFileMeta(){
    const url = `https://api.github.com/repos/${state.cfg.owner}/${state.cfg.repo}/contents/${state.cfg.path}?ref=${encodeURIComponent(state.cfg.branch||'main')}`;
    const res = await fetch(url, { headers:{ 'Authorization':'Bearer '+state.cfg.token, 'Accept':'application/vnd.github+json' } });
    if(!res.ok) throw new Error('Fetch failed ('+res.status+')');
    return res.json();
  }

  // helpers
  function show(el,on){ el.classList.toggle('show', !!on); }
  function download(blob,name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }

  // reload
  reloadBtn.addEventListener('click', ()=> loadData(true));

  // ===== NEW: manual Sync / Pull buttons =====
  document.getElementById('syncNow').addEventListener('click', async ()=>{
    try{ await saveToPouch(); }catch(e){ console.error(e); }
  });
  document.getElementById('pullNow').addEventListener('click', async ()=>{
    try{
      await PouchDB.replicate(remoteDB, localDB, { doc_ids:[STATE_DOC_ID] });
      const doc = await localDB.get(STATE_DOC_ID).catch(()=>null);
      if(doc) await applyDoc(doc);
    }catch(e){ console.error(e); }
  });

  // ===== INIT =====
  await bootstrapRemoteFirst(); // brings back your drafts/deletes/settings if you cleared browser data
  await loadData();            // loads jobs.json view
  startLiveSync();             // keep in sync continuously
})();
</script>
</body>
</html>
