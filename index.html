<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Current Due Task — Daily Reset Tracker</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0f1220; --card:#161b2b; --ink:#eef1ff; --muted:#9aa3c7; --line:#2a3052;
    --accent:#6ca8ff; --ok:#7bd88f; --warn:#ffd166; --bad:#ff7575;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:var(--accent);color:#06102a;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  button.secondary{background:#202a44;color:var(--ink);border:1px solid var(--line)}
  button.small{padding:4px 8px;border-radius:8px;font-size:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
  tbody td{background:#101731;border:1px solid var(--line);padding:10px;border-left:0;border-right:0;vertical-align:middle}
  tbody tr td:first-child{border-left:1px solid var(--line);border-radius:10px 0 0 10px}
  tbody tr td:last-child{border-right:1px solid var(--line);border-radius:0 10px 10px 0}
  input[type="text"]{width:100%;background:#0b1128;border:1px solid var(--line);color:var(--ink);
    padding:8px 10px;border-radius:8px;outline:none}
  input[type="text"]::placeholder{color:#6b7280}
  .center{display:flex;align-items:center;justify-content:center}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#0b1128;color:#9aa3c7;font-size:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kpi{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0b1128}
  .kpi .n{font-weight:800;font-size:18px}
  .kpi .label{color:#9aa3c7;font-size:12px}
  .right{text-align:right}
  .del{background:#23121a;color:#ffd6da;border:1px solid #4b1a23}
  .foot{display:flex;justify-content:flex-end;margin-top:6px;color:#9aa3c7;font-size:12px}

  /* side-by-side checkboxes */
  .checks{display:flex;gap:16px;align-items:center;justify-content:center;flex-wrap:wrap}
  .ck{display:inline-flex;align-items:center;gap:6px;color:var(--muted);font-size:12px;user-select:none}
  .ck input{transform:scale(1.2)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Current Due Task</h1>
    <div class="controls">
      <span class="badge" id="todayLabel"></span>
      <span class="badge" id="activeTopicsBadge" title="Topics not checked as done">Active Topics: 0</span>
      <button id="addRow">+ Add Row</button>
      <button id="resetToday" class="secondary">Reset Today</button>
    </div>
  </header>

  <section class="panel">
    <table>
      <thead>
        <tr>
          <th style="width:34px">#</th>
          <th>Subject</th>
          <th>Active Topic</th>
          <th class="center">Chunk • Topic • Subject</th>
          <th style="width:64px"></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
    <div class="foot">Autosaves to your browser. <b>Chunk</b> resets daily only if Topic isn’t done.</div>
  </section>

  <h2 style="font-size:16px;margin:18px 0 8px">Today Progress Report</h2>
  <section class="panel">
    <div class="grid">
      <div class="kpi">
        <div class="n" id="chunksDoneN">0</div>
        <div><div class="label">Chunks completed today</div><div class="label">Total today: <span id="chunksTotalN">0</span></div></div>
      </div>
      <div class="kpi">
        <div class="n" id="topicsDoneN">0</div>
        <div><div class="label">Topics done today</div><div class="label">Total active: <span id="topicsActiveN">0</span></div></div>
      </div>
      <div class="kpi">
        <div class="n" id="subjectsDoneN">0</div>
        <div><div class="label">Subjects done today</div><div class="label">Total active: <span id="subjectsActiveN">0</span></div></div>
      </div>
    </div>
  </section>
</div>

<script>
(() => {
  // ---------- Keys & helpers ----------
  const TASKS_KEY = "cdt_tasks_v2";
  const NEXTID_KEY = "cdt_nextid_v2";
  const LASTDATE_KEY = "cdt_last_date_v2";
  const statusKey = k => `cdt_status_${k}`;
  const dateKey = (d=new Date()) => {
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  };
  const debounce = (fn, ms=180) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  function loadTasks(){ try{ const t=JSON.parse(localStorage.getItem(TASKS_KEY)||"[]"); t.forEach(x=>{ if(typeof x.topicDone!=='boolean') x.topicDone=false; if(typeof x.subjectDone!=='boolean') x.subjectDone=false; }); return t; }catch{return[];} }
  function writeTasks(arr){ localStorage.setItem(TASKS_KEY, JSON.stringify(arr)); }
  function saveTasksAndRender(arr){ writeTasks(arr); render(); }
  function nextId(){ const n=+(localStorage.getItem(NEXTID_KEY)||"1"); localStorage.setItem(NEXTID_KEY,String(n+1)); return n; }

  function loadStatus(dk){ try{ return JSON.parse(localStorage.getItem(statusKey(dk))||"{}"); }catch{return{};} }
  function saveStatus(dk,obj){ localStorage.setItem(statusKey(dk), JSON.stringify(obj)); updateKPIs(); }

  const $rows=document.getElementById("rows");

  // KPIs
  const $todayLabel=document.getElementById("todayLabel");
  const $activeTopicsBadge=document.getElementById("activeTopicsBadge");
  const $chunksDoneN=document.getElementById("chunksDoneN");
  const $chunksTotalN=document.getElementById("chunksTotalN");
  const $topicsDoneN=document.getElementById("topicsDoneN");
  const $topicsActiveN=document.getElementById("topicsActiveN");
  const $subjectsDoneN=document.getElementById("subjectsDoneN");
  const $subjectsActiveN=document.getElementById("subjectsActiveN");

  function render(){
    const tasks=loadTasks();
    const dk=dateKey();
    const st=loadStatus(dk);
    $todayLabel.textContent=`Today: ${dk}`;
    $rows.innerHTML="";

    tasks.forEach((t,idx)=>{
      const per=st[t.id]||{chunk:false,topicToday:false,subjectToday:false};
      const chunkChecked = t.topicDone ? true : !!per.chunk;
      const topicChecked = !!t.topicDone;
      const subjectChecked = !!t.subjectDone;

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="center">${idx+1}</td>
        <td><input type="text" placeholder="Subject…" value="${t.subject||""}" autocapitalize="sentences" spellcheck="false"></td>
        <td><input type="text" placeholder="Active topic…" value="${t.topic||""}" autocapitalize="sentences" spellcheck="false"></td>
        <td class="center">
          <div class="checks">
            <label class="ck"><input type="checkbox" ${chunkChecked?"checked":""} ${t.topicDone?"disabled":""}><span>Chunk</span></label>
            <label class="ck"><input type="checkbox" ${topicChecked?"checked":""}><span>Topic</span></label>
            <label class="ck"><input type="checkbox" ${subjectChecked?"checked":""}><span>Subject</span></label>
          </div>
        </td>
        <td class="right"><button class="small del">Delete</button></td>
      `;

      const debouncedPersist = debounce(()=>writeTasks(tasks));

      // inputs
      tr.children[1].querySelector("input").addEventListener("input", e => { t.subject=e.target.value; debouncedPersist(); });
      tr.children[2].querySelector("input").addEventListener("input", e => { t.topic=e.target.value; debouncedPersist(); });

      const [chunkEl, topicEl, subjectEl] = tr.querySelectorAll(".checks input");

      chunkEl.addEventListener("change", e => {
        const dk=dateKey(); const st=loadStatus(dk);
        st[t.id]=st[t.id]||{chunk:false,topicToday:false,subjectToday:false};
        st[t.id].chunk=e.target.checked;
        saveStatus(dk,st);
      });

      topicEl.addEventListener("change", e => {
        const dk=dateKey(); const st=loadStatus(dk);
        const checked=e.target.checked;
        t.topicDone=checked;
        st[t.id]=st[t.id]||{chunk:false,topicToday:false,subjectToday:false};
        st[t.id].topicToday=checked;
        if(checked){ st[t.id].chunk=true; chunkEl.checked=true; chunkEl.disabled=true; }
        else{ chunkEl.disabled=false; }
        saveTasksAndRender(tasks);
        saveStatus(dk,st);
      });

      subjectEl.addEventListener("change", e => {
        const dk=dateKey(); const st=loadStatus(dk);
        const checked=e.target.checked;
        t.subjectDone=checked;
        st[t.id]=st[t.id]||{chunk:false,topicToday:false,subjectToday:false};
        st[t.id].subjectToday=checked;
        writeTasks(tasks);
        saveStatus(dk,st);
      });

      tr.querySelector(".del").addEventListener("click", ()=>{
        const tasks2=loadTasks().filter(x=>x.id!==t.id);
        saveTasksAndRender(tasks2);
      });

      $rows.appendChild(tr);
    });

    updateKPIs();
  }

  function updateKPIs(){
    const tasks=loadTasks();
    const st=loadStatus(dateKey());

    let chunksDoneToday=0, topicsDoneToday=0, subjectsDoneToday=0;
    tasks.forEach(t=>{
      const s=st[t.id]||{};
      if(s.chunk) chunksDoneToday++;
      if(s.topicToday) topicsDoneToday++;
      if(s.subjectToday) subjectsDoneToday++;
    });

    const activeTopics=tasks.filter(t=>!t.topicDone).length;
    const activeSubjects=tasks.filter(t=>!t.subjectDone).length;

    $chunksDoneN.textContent=chunksDoneToday;
    $chunksTotalN.textContent=activeTopics;
    $topicsDoneN.textContent=topicsDoneToday;
    $topicsActiveN.textContent=activeTopics;
    $subjectsDoneN.textContent=subjectsDoneToday;
    $subjectsActiveN.textContent=activeSubjects;
    $activeTopicsBadge.textContent=`Active Topics: ${activeTopics}`;
  }

  // Add / Reset
  document.getElementById("addRow").addEventListener("click", ()=>{
    const tasks=loadTasks();
    tasks.push({id:nextId(),subject:"",topic:"",topicDone:false,subjectDone:false,created:Date.now()});
    saveTasksAndRender(tasks);
  });

  function clearTodayStatuses(){
    const dk=dateKey();
    localStorage.removeItem(statusKey(dk));
    localStorage.setItem(LASTDATE_KEY, dk);
    render();
  }
  document.getElementById("resetToday").addEventListener("click", ()=>{
    if(confirm("Reset today's ticks? (Topic/Subject Done stay)")) clearTodayStatuses();
  });

  // Midnight rollover
  function ensureToday(){
    const dk=dateKey();
    const last=localStorage.getItem(LASTDATE_KEY);
    if(last!==dk){ localStorage.setItem(LASTDATE_KEY, dk); render(); }
  }
  setInterval(ensureToday, 60*1000);
  if(!localStorage.getItem(LASTDATE_KEY)) localStorage.setItem(LASTDATE_KEY, dateKey());

  render();
})();
</script>
</body>
</html>
